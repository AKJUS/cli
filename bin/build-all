#!/bin/bash

set -e -x

echo "Creating release dir..."
mkdir -p release

# variables as defined by "go tool nm"
OSVAR=github.com/exercism/cli/cmd.BuildOS
ARCHVAR=github.com/exercism/cli/cmd.BuildARCH
ARMVAR=github.com/exercism/cli/cmd.BuildARM

# handle alternate binary name for pre-releases
BINNAME=${NAME:-exercism}

get_shell_completions() {
        SHELLCOMP_BASEURL=http://cli.exercism.io/shell/exercism_completion
        curl -O $SHELLCOMP_BASEURL.bash -O $SHELLCOMP_BASEURL.zsh
}

cleanup() {
        rm -f exercism_completion.bash exercism_completion.zsh
}

createRelease() {
	os=$1
	arch=$2
	arm=$3

	if [ "$os" = darwin ]
	then
		osname='mac'
	else
		osname=$os
	fi
	if [ "$arch" = amd64 ]
	then
		osarch=64bit
	elif [ "$os" = linux ] && [ "$arch" = ppc64 ]
        then
                osarch=ppc64
        else
		osarch=32bit

	fi

	ldflags="-s -w -X $OSVAR=$os -X $ARCHVAR=$arch"
	if [ "$arm" ]
	then
		osarch=arm-v$arm
		ldflags="$ldflags -X $ARMVAR=$arm"
	elif [ "$arch" = arm64 ]
	then
		osarch=arm-v8
		ldflags="$ldflags -X $ARMVAR=8"
	fi

	binname=$BINNAME
	if [ "$osname" = windows ]
	then
		binname="$binname.exe"
	fi

	relname="../release/$BINNAME-$osname-$osarch"
	echo "Creating $os/$arch binary..."

	if [ "$arm" ]
	then
		GOOS=$os GOARCH=$arch GOARM=$arm go build -ldflags "$ldflags" -o "out/$binname" exercism/main.go
	else
		GOOS=$os GOARCH=$arch go build -ldflags "$ldflags" -o "out/$binname" exercism/main.go
	fi

	cd out

	if [ "$osname" = windows ]
	then
		zip "$relname.zip" "$binname" ../exercism_completion* ../BUILD.md
	else
		tar cvzf "$relname.tgz" "$binname" ../exercism_completion* ../BUILD.md
	fi
	cd ..
}

get_shell_completions

# Mac Releases
createRelease darwin 386
createRelease darwin amd64

# PowerPC Releases
createRelease linux ppc64

# Linux Releases
createRelease linux 386
createRelease linux amd64

# FreeBSD Releases
createRelease freebsd 386
createRelease freebsd amd64

# OpenBSD Releases
createRelease openbsd 386
createRelease openbsd amd64

# ARM Releases
createRelease linux arm 5
createRelease linux arm 6
createRelease linux arm 7
createRelease linux arm64

# Windows Releases
createRelease windows 386
createRelease windows amd64

cleanup
